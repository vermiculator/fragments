---
import { getCollection } from 'astro:content';
import Layout from '../../components/Layout.astro';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

const allEntries = await getCollection('earth');
const entry = allEntries.find(e => e.id === slug);

if (!entry) {
  console.log(`[earth] No entry found for slug: ${slug}`);
  console.log(`[earth] Available IDs:`, allEntries.slice(0, 5).map(e => e.id));
  return Astro.redirect('/404');
}

console.log(`[earth] Found entry: ${entry.id}, has render: ${typeof entry.render}`);
console.log(`[earth] Entry keys:`, Object.keys(entry));

let Content;
try {
  if (typeof entry.render === 'function') {
    const rendered = await entry.render();
    Content = rendered.Content;
  } else if (entry.body) {
    // Fallback: render raw markdown as text
    const { compile } = await import('astro:content');
    const result = await compile(entry);
    Content = result.Content;
  } else {
    throw new Error('No render method or body available');
  }
} catch (err) {
  console.error(`[earth] Error rendering ${slug}:`, err);
  console.error(`[earth] Error stack:`, err.stack);
  return Astro.redirect('/404');
}
---

<Layout pageTitle={entry.data.title} pageStyle="earth">
  <Content />
</Layout>
