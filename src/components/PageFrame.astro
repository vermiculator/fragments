---
import ThesisWrapper from './collections/ThesisWrapper.astro';
import EarthWrapper from './collections/EarthWrapper.astro';
import LibraryWrapper from './collections/LibraryWrapper.astro';
import EntitiesWrapper from './collections/EntitiesWrapper.astro';
import AboutWrapper from './collections/AboutWrapper.astro';
import MetaThesisWrapper from './collections/MetaThesisWrapper.astro';
import StructuralWrapper from './collections/StructuralWrapper.astro';
import '@fontsource-variable/grenze-gotisch';
import '@fontsource-variable/noto-serif';
import BottomNavWrapper from './BottomNavWrapper.astro';
import SidebarWrapper from './SidebarWrapper.astro';
import { baseify } from '@/scripts/util';

// Safely access starlightRoute
let starlightRoute: any = {};
try {
	starlightRoute = Astro.locals.starlightRoute || {};
} catch (e) {
	starlightRoute = {};
}

const { hasSidebar, entry, id } = starlightRoute;
const collection = id ? baseify(id) : '';
const isThesisPage = id?.startsWith('works/thesis/');
const isAboutPage = id?.startsWith('plain/about/');
const isMetaThesisPage = id?.startsWith('works/thesis/meta-thesis/');
const isStructuralPage = id?.startsWith('plain/structural/');

// Check if this is a splash page (index, 404)
const isSplashPage = Astro.props?.frontmatter?.template === 'splash' || 
                     starlightRoute?.frontmatter?.template === 'splash';
---

<div class="page sl-flex">
	<header class="header"><slot name="header" /></header>
	<div class="main-frame">
		{(() => {
			if (isThesisPage) {
				return (
					<ThesisWrapper entry={entry}>
						{hasSidebar && (
							<SidebarWrapper>
								<slot name="sidebar" slot="sidebar" />
							</SidebarWrapper>
						)}
						<BottomNavWrapper />
						<div class="main-content"><slot /></div>
					</ThesisWrapper>
				);
			}
			if (isAboutPage) {
				return (
					<AboutWrapper entry={entry}>
						{hasSidebar && (
							<SidebarWrapper>
								<slot name="sidebar" slot="sidebar" />
							</SidebarWrapper>
						)}
						<div class="main-content"><slot /></div>
					</AboutWrapper>
				);
			}
			if (isMetaThesisPage) {
				return (
					<MetaThesisWrapper entry={entry}>
						{hasSidebar && (
							<SidebarWrapper>
								<slot name="sidebar" slot="sidebar" />
							</SidebarWrapper>
						)}
						<BottomNavWrapper />
						<div class="main-content"><slot /></div>
					</MetaThesisWrapper>
				);
			}
			if (isStructuralPage) {
				return (
					<StructuralWrapper entry={entry}>
						{hasSidebar && (
							<SidebarWrapper>
								<slot name="sidebar" slot="sidebar" />
							</SidebarWrapper>
						)}
						<div class="main-content"><slot /></div>
					</StructuralWrapper>
				);
			}
			switch (collection as string) {
				case 'earth/':
					return (
						<EarthWrapper entry={entry}>
							{hasSidebar && (
								<SidebarWrapper>
									<slot name="sidebar" slot="sidebar" />
								</SidebarWrapper>
							)}
							<BottomNavWrapper />
							<div class="main-content"><slot /></div>
						</EarthWrapper>
					);
				case 'library/':
					return (
						<LibraryWrapper entry={entry}>
							{hasSidebar && (
								<SidebarWrapper>
									<slot name="sidebar" slot="sidebar" />
								</SidebarWrapper>
							)}
							<BottomNavWrapper />
							<div class="main-content"><slot /></div>
						</LibraryWrapper>
					);
				case 'entities/':
					return (
						<EntitiesWrapper entry={entry}>
							{hasSidebar && (
								<SidebarWrapper>
									<slot name="sidebar" slot="sidebar" />
								</SidebarWrapper>
							)}
							<BottomNavWrapper />
							<div class="main-content"><slot /></div>
						</EntitiesWrapper>
					);
				default:
					return (
						<>
							{!isSplashPage && hasSidebar && (
								<SidebarWrapper>
									<slot name="sidebar" slot="sidebar" />
								</SidebarWrapper>
							)}
							<div class="main-content"><slot /></div>
						</>
					);
			}
		})()}
	</div>
</div>

<style>
	:root {
		.page {
			flex-direction: column;
			min-height: 100vh;
		}

		.header {
			z-index: var(--sl-z-index-navbar);
			position: fixed;
			inset-inline-start: 0;
			inset-block-start: 0;
			width: 100%;
			height: var(--sl-nav-height);
			border-bottom: 1px solid var(--sl-color-hairline-shade);
			padding: var(--sl-nav-pad-y) var(--sl-nav-pad-x);
			padding-inline-end: var(--sl-nav-pad-x);
			background-color: var(--sl-color-bg-nav);
		}

		:global([data-has-sidebar]) .header {
			padding-inline-end: calc(
				var(--sl-nav-gap) + var(--sl-nav-pad-x) + var(--sl-menu-button-size)
			);
		}

		.main-frame {

		}

		.main-content {
			padding-top: calc(var(--sl-nav-height) + var(--sl-mobile-toc-height));
			padding-inline-start: var(--sl-content-inline-start);
			padding-bottom: 20vh;
		}
	}
</style>