---

import { debracketKeepFirst, debracketKeepTitleOrAlias, slugify, getAllEntriesFromCollections } from '@/scripts/util';
import LinkCard from './LinkCard.astro';

const { links, currentKind, side } = Astro.props;

// Get all entries so we can look up their collections
const allEntries = await getAllEntriesFromCollections();
---

  {links && links.length > 0
                        ? links.map((link: { id: string; collection?: string }) => {
                      const title = debracketKeepTitleOrAlias(link.id);
                      const unslugged = debracketKeepFirst(link.id);

                      // Split into path segments and slugify only the last one
                      const segments = unslugged.split('/').filter(s => s.trim());
                      const lastSegment = segments[segments.length - 1];
                      const slug = slugify(lastSegment) || lastSegment;

                      // Reconstruct path: preserve middle segments + slugified final segment
                      const pathSegments = segments.slice(0, -1);
                      pathSegments.push(slug);
                      const fullId = pathSegments.join('/');

                      // Find which collection contains this entry (search by slug match or full id)
                      let resolvedCollection: string | undefined;
                      for (const entry of allEntries) {
                        if (entry.id === fullId || entry.id.includes(slug)) {
                          resolvedCollection = entry.collection;
                          break;
                        }
                      }

                      let safeKind = resolvedCollection || currentKind || 'earth';
                      if (safeKind == 'docs'){safeKind = 'earth'};

                      // If fullId has multiple segments, it's already a full path like works/thesis/slug
                      // In that case, use it directly. Otherwise prepend the collection.
                      const fullPath = fullId.includes('/') 
                        ? `/${fullId}/`
                        : `/${safeKind}/${fullId}/`;

                      return (
                        <LinkCard
                          arrow={side}
                          title={title}
                          href={fullPath}
                        />
                      );
                    })
                  : ''}